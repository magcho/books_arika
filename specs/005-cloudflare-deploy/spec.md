# Feature Specification: Cloudflareへのデプロイ設定

**Feature Branch**: `005-cloudflare-deploy`  
**Created**: 2025-01-27  
**Status**: Draft  
**Input**: User description: "cloudflareへのデプロイ設定を進めたいです"

## Clarifications

### Session 2025-01-27

- Q: デプロイ失敗時のロールバック戦略はどうするか？ → A: Cloudflare WorkersのGitHub統合を利用する形で実装する
- Q: フロントエンドのデプロイ方法はどうするか？ → A: Cloudflare PagesのGitHub統合を使用する
- Q: データベースマイグレーションの実行方法はどうするか？ → A: デプロイ時に自動的にマイグレーションを実行する。PRのマージ前に、デプロイ時にマイグレーションが実行されるかどうかをコメントで通知する仕組みを実装する（マイグレーションを実行する場合も、実行しない場合も、その旨を通知する）
- Q: デプロイ通知の方法はどうするか？ → A: GitHubのコミットステータスとPRコメントで通知する
- Q: マイグレーション実行中のエラーハンドリングはどうするか？ → A: マイグレーション失敗時はデプロイを中止し、ロールバックする

## User Scenarios & Testing *(mandatory)*

### User Story 1 - バックエンドAPIの本番環境へのデプロイ (Priority: P1)

開発者がバックエンドAPIを本番環境にデプロイし、本番環境で動作させる。

**Why this priority**: バックエンドAPIが本番環境で利用可能になることで、フロントエンドが実際のAPIと連携できるようになる。これはアプリケーション全体が動作するための基盤となる。

**Independent Test**: 開発者がデプロイコマンドを実行し、バックエンドAPIが本番環境に正常にデプロイされることを確認できる。デプロイ後、本番環境のAPIエンドポイントにアクセスして正常にレスポンスが返ることを確認できる。

**Acceptance Scenarios**:

1. **Given** バックエンドのコードが完成している, **When** 開発者がデプロイコマンドを実行する, **Then** バックエンドAPIが本番環境に正常にデプロイされ、本番環境のAPIが利用可能になる
2. **Given** 本番環境のD1データベースが設定されている, **When** APIがデータベースにアクセスする, **Then** 本番環境のデータベースから正常にデータを取得・更新できる
3. **Given** 環境変数が設定されている, **When** APIが外部サービス（Google Books APIなど）にアクセスする, **Then** 環境変数から正しく認証情報を取得してアクセスできる

---

### User Story 2 - フロントエンドの本番環境へのデプロイ (Priority: P1)

開発者がフロントエンドアプリケーションをCloudflare PagesのGitHub統合機能により本番環境にデプロイし、本番環境で公開する。

**Why this priority**: フロントエンドが本番環境で公開されることで、エンドユーザーがアプリケーションにアクセスできるようになる。バックエンドと同様に、アプリケーション全体が動作するための基盤となる。Cloudflare PagesのGitHub統合を利用することで、バックエンドと同様のデプロイプロセスを実現し、自動デプロイとロールバック機能を活用できる。

**Independent Test**: 開発者がmainブランチにコードをプッシュし、Cloudflare PagesのGitHub統合が自動的にビルドとデプロイを実行し、本番環境のURLでアプリケーションが正常に表示されることを確認できる。フロントエンドから本番環境のバックエンドAPIに正常にリクエストを送信できることを確認できる。デプロイ失敗時には、統合機能が提供するロールバック機能が利用できることを確認できる。

**Acceptance Scenarios**:

1. **Given** フロントエンドのコードが完成している, **When** 開発者がmainブランチにプッシュする, **Then** Cloudflare PagesのGitHub統合が自動的にビルドとデプロイを実行し、本番環境のURLでアプリケーションが正常に表示される
2. **Given** 本番環境のバックエンドAPIのURLが設定されている, **When** フロントエンドがAPIリクエストを送信する, **Then** 本番環境のバックエンドAPIに正常に接続できる
3. **Given** ビルドが成功している, **When** デプロイが完了する, **Then** 静的ファイルが正しく配信され、アプリケーションが正常に動作する
4. **Given** デプロイ中にエラーが発生している, **When** Cloudflare PagesのGitHub統合がエラーを検出する, **Then** 自動的に前のバージョンにロールバックされる、またはエラーが報告される

---

### User Story 3 - CI/CDパイプラインによる自動デプロイ (Priority: P2)

開発者がコードをリポジトリにプッシュすると、Cloudflare WorkersとCloudflare PagesのGitHub統合機能により自動的にテストが実行され、成功した場合に本番環境にデプロイされる。

**Why this priority**: 自動デプロイにより、手動でのデプロイ作業が不要になり、デプロイの一貫性と信頼性が向上する。また、テストが失敗した場合は自動的にデプロイが停止されるため、本番環境への不具合の混入を防げる。Cloudflare WorkersとCloudflare PagesのGitHub統合を利用することで、バックエンドとフロントエンドの両方のデプロイプロセスを簡素化し、ロールバック機能を提供できる。デプロイ時の自動マイグレーション実行により、データベーススキーマの更新も自動化され、デプロイプロセスの完全な自動化が実現できる。PRコメントによるマイグレーション実行通知により、レビュアーはデプロイ時の影響を事前に把握できる。

**Independent Test**: 開発者がmainブランチにコードをプッシュし、Cloudflare WorkersとCloudflare PagesのGitHub統合が自動的にテストを実行し、成功した場合に自動的にデプロイされることを確認できる。テストが失敗した場合、デプロイが実行されないことを確認できる。デプロイ失敗時には、統合機能が提供するロールバック機能が利用できることを確認できる。

**Acceptance Scenarios**:

1. **Given** コードがmainブランチにプッシュされている, **When** Cloudflare WorkersとCloudflare PagesのGitHub統合が実行される, **Then** テストが自動的に実行され、成功した場合にバックエンドとフロントエンドが本番環境に自動デプロイされる
2. **Given** テストが失敗している, **When** Cloudflare WorkersとCloudflare PagesのGitHub統合が実行される, **Then** デプロイが実行されず、GitHubのコミットステータスとPRコメントでエラーが報告される
3. **Given** プルリクエストが作成されている, **When** Cloudflare WorkersとCloudflare PagesのGitHub統合が実行される, **Then** テストのみが実行され、デプロイは実行されない
4. **Given** デプロイ中にエラーが発生している, **When** Cloudflare WorkersとCloudflare PagesのGitHub統合がエラーを検出する, **Then** 自動的に前のバージョンにロールバックされる、またはGitHubのコミットステータスとPRコメントでエラーが報告される
5. **Given** デプロイが成功している, **When** デプロイが完了する, **Then** GitHubのコミットステータスが成功を示し、PRコメントにデプロイ完了の通知が追加される
6. **Given** プルリクエストにデータベースマイグレーションファイルが含まれている, **When** プルリクエストが作成または更新される, **Then** PRにコメントが自動的に追加され、デプロイ時にマイグレーションが実行される旨が通知される
7. **Given** プルリクエストにデータベースマイグレーションファイルが含まれていない, **When** プルリクエストが作成または更新される, **Then** PRにコメントが自動的に追加され、デプロイ時にマイグレーションが実行されない旨が通知される
8. **Given** データベースマイグレーションファイルが含まれている, **When** デプロイが実行される, **Then** デプロイ時に自動的にマイグレーションが実行される
9. **Given** マイグレーション実行中にエラーが発生している, **When** マイグレーションが失敗する, **Then** デプロイが中止され、自動的に前のバージョンにロールバックされ、GitHubのコミットステータスとPRコメントでエラーが報告される

---

### User Story 4 - 環境変数とシークレットの管理 (Priority: P2)

開発者が本番環境の環境変数とシークレットを安全に設定・管理できる。

**Why this priority**: APIキーやデータベース認証情報などの機密情報を安全に管理する必要がある。また、環境ごとに異なる設定値を適切に管理することで、開発環境と本番環境の分離を実現できる。

**Independent Test**: 開発者が管理ツールを使用して環境変数とシークレットを設定し、アプリケーションが正しくそれらを読み込むことを確認できる。シークレットがコードリポジトリに含まれていないことを確認できる。

**Acceptance Scenarios**:

1. **Given** 本番環境のAPIキーが準備されている, **When** 開発者がシークレットを設定する, **Then** アプリケーションが正しくシークレットを読み込み、外部APIにアクセスできる
2. **Given** 環境変数が設定されている, **When** アプリケーションが起動する, **Then** 環境変数から正しく設定値を読み込む
3. **Given** シークレットが設定されている, **When** コードリポジトリを確認する, **Then** シークレットがコードに含まれていない

---

### Edge Cases

- デプロイ中にエラーが発生した場合、Cloudflare WorkersのGitHub統合が提供するロールバック機能を利用する
- 複数の環境（ステージング、本番）を管理する場合、どのように環境を切り替えるか？
- デプロイ時にデータベースマイグレーションが必要な場合、デプロイ時に自動的にマイグレーションを実行する。PRのマージ前に、マイグレーションの実行有無をPRコメントで通知する
- フロントエンドとバックエンドのデプロイタイミングが異なる場合、互換性をどのように保証するか？
- カスタムドメインを設定する場合、どのようにDNS設定を行うか？
- マイグレーション実行中にエラーが発生した場合、マイグレーション失敗時はデプロイを中止し、自動的に前のバージョンにロールバックする

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはバックエンドAPIを本番環境にデプロイできる必要がある
- **FR-002**: システムはCloudflare PagesのGitHub統合を通じてフロントエンドアプリケーションを本番環境にデプロイできる必要がある
- **FR-003**: システムは本番環境のデータベースに接続できる必要がある
- **FR-004**: システムは環境変数とシークレットを安全に管理できる必要がある
- **FR-005**: システムはCloudflare WorkersとCloudflare PagesのGitHub統合を通じて自動デプロイを実行できる必要がある
- **FR-006**: システムはデプロイ前に自動的にテストを実行する必要がある
- **FR-007**: システムはデプロイの成功・失敗をGitHubのコミットステータスとPRコメントで通知できる必要がある
- **FR-008**: システムはフロントエンドが本番環境のバックエンドAPIのURLを正しく参照できる必要がある
- **FR-009**: システムはビルド成果物を適切なディレクトリに出力する必要がある
- **FR-010**: システムはデプロイ時に適切な環境設定（本番/開発）を適用できる必要がある
- **FR-011**: システムはデプロイ時にデータベースマイグレーションを自動的に実行できる必要がある
- **FR-012**: システムはプルリクエストに、デプロイ時のマイグレーション実行有無をコメントで通知できる必要がある
- **FR-013**: システムはマイグレーション失敗時にデプロイを中止し、自動的にロールバックできる必要がある

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者は1回のコマンド実行でバックエンドを本番環境にデプロイできる（手動デプロイの場合）
- **SC-002**: 開発者はコードをプッシュしてから5分以内に自動デプロイが完了する（CI/CDパイプラインの場合）
- **SC-003**: デプロイ後、本番環境のAPIエンドポイントが95%以上の時間で正常に応答する
- **SC-004**: デプロイ後、本番環境のフロントエンドアプリケーションが95%以上の時間で正常に表示される
- **SC-005**: テストが失敗した場合、100%の確率でデプロイが実行されない
- **SC-006**: 環境変数とシークレットがコードリポジトリに含まれることがない（100%の確率）
- **SC-007**: デプロイプロセス全体（ビルドから公開まで）が10分以内に完了する

## Assumptions

- Cloudflareアカウントが既に作成されており、適切な権限が設定されている
- 本番環境用のD1データベースが既に作成されている、または作成プロセスが明確になっている
- GitHubリポジトリが既に設定されており、Cloudflare WorkersとCloudflare PagesのGitHub統合が利用可能である
- カスタムドメインの設定は本機能の範囲外とする（将来の機能拡張として検討）
- 複数の環境（ステージング、本番）の管理は、まず本番環境の設定を完了してから検討する
