# Feature Specification: Storybook Visual Regression Testing

**Feature Branch**: `004-storybook-vrt`  
**Created**: 2024-12-19  
**Status**: Draft  
**Input**: User description: "Storybookに掲載したストーリーをGitHub ActionsでVRT（Visual Regression Testing）するための技術選定と実装を実施する。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ローカル環境でのVRT実行 (Priority: P1)

開発者は、コード変更後にローカル環境でVRTを実行し、視覚的な回帰がないことを確認できる。

**Why this priority**: 開発者が変更をコミットする前に問題を早期発見できるため、最も基本的な機能として必要。

**Independent Test**: 開発者がローカル環境でコマンドを実行し、すべてのStorybookストーリーのスクリーンショットが取得され、ベースラインと比較できることを確認できる。

**Acceptance Scenarios**:

1. **Given** Storybookストーリーが存在し、ベースラインスクリーンショットが設定されている, **When** 開発者がVRTコマンドを実行する, **Then** すべてのストーリーのスクリーンショットが取得され、ベースラインと比較される
2. **Given** 視覚的な変更がない状態でVRTを実行する, **When** スクリーンショットが取得される, **Then** 差分が検出されず、テストが成功する
3. **Given** 視覚的な変更がある状態でVRTを実行する, **When** スクリーンショットが取得される, **Then** 差分が検出され、差分レポートが生成される

---

### User Story 2 - PR作成時の自動VRT実行 (Priority: P1)

開発者がmainブランチへのPRを作成すると、GitHub Actionsで自動的にVRTが実行される。

**Why this priority**: CI/CDパイプラインに統合することで、すべてのPRで一貫して視覚的回帰を検出できるため、P1として必要。

**Independent Test**: 開発者がPRを作成し、GitHub ActionsでVRTが自動実行され、結果が確認できることを検証できる。

**Acceptance Scenarios**:

1. **Given** 開発者がmainブランチへのPRを作成する, **When** PRが作成される, **Then** GitHub ActionsでVRTが自動的に実行される
2. **Given** VRTが実行される, **When** すべてのストーリーのスクリーンショットが取得される, **Then** 結果がGitHub ActionsのArtifactsに保存される
3. **Given** 差分が検出された場合, **When** VRTが完了する, **Then** 開発者は差分レポートを確認できる
4. **Given** VRTで差分が検出され失敗した場合, **When** VRTが完了する, **Then** PRのマージがブロックされる

---

### User Story 3 - 差分レポートの確認 (Priority: P2)

開発者は、VRTで検出された視覚的な差分をレポートで確認し、意図的な変更か不具合かを判断できる。

**Why this priority**: 差分が検出された場合に、開発者が適切に判断するために必要。ただし、基本的なVRT実行（P1）が完了した後に実装される。

**Independent Test**: 開発者が差分レポートを確認し、変更内容を視覚的に確認できることを検証できる。

**Acceptance Scenarios**:

1. **Given** VRTで差分が検出される, **When** レポートが生成される, **Then** 開発者は差分画像を確認できる
2. **Given** 差分レポートが存在する, **When** 開発者がレポートを確認する, **Then** 変更前、変更後、差分画像が表示される

---

### Edge Cases

- Storybookストーリーが存在しない場合、VRTはどのように動作するか？
- ストーリーのレンダリングに時間がかかる場合、適切に待機してからスクリーンショットを取得できるか？
- アニメーションやローディング状態が含まれるストーリーの場合、適切なタイミングでスクリーンショットを取得できるか？
- ベースラインが存在しない初回実行時、どのように動作するか？（初回実行時に自動的にベースラインを作成し、Artifactsに保存）
- CI環境でベースラインをArtifactsから取得できない場合、どのように動作するか？
- 差分検出時に自動更新オプションを使用した場合、意図しない変更がベースラインに反映されないか？
- VRTが失敗した場合、PRのマージがブロックされるが、開発者はどのように対応するか？
- スクリーンショット取得や比較プロセスでエラーが発生した場合、エラーが発生したストーリーをスキップし、他のストーリーのテストを継続できるか？
- 大量のストーリーがある場合、実行時間が許容範囲内に収まるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、すべてのStorybookストーリーに対してスクリーンショットを取得できる
- **FR-002**: システムは、取得したスクリーンショットをベースラインと比較し、視覚的な差分を検出できる
- **FR-003**: システムは、差分が検出された場合、変更前、変更後、差分画像を含むレポートを生成できる
- **FR-004**: システムは、ローカル環境でVRTを実行できる
- **FR-005**: システムは、GitHub ActionsでPR作成時に自動的にVRTを実行できる
- **FR-006**: システムは、外部サービスに依存せず、セキュリティ要件を満たす
- **FR-007**: システムは、ストーリーのレンダリング完了を待機してからスクリーンショットを取得する
- **FR-008**: システムは、VRTの実行結果をArtifactsとして保存できる
- **FR-009**: システムは、差分検出の閾値を設定できる（デフォルト閾値を設定し、必要に応じて個別のストーリーで上書き可能）
- **FR-010**: システムは、差分検出時に自動的にベースラインを更新するオプションを提供できる（デフォルトは手動更新）
- **FR-011**: システムは、VRTで差分が検出され失敗した場合、PRのマージをブロックできる
- **FR-012**: システムは、スクリーンショット取得や比較プロセスでエラーが発生したストーリーをスキップし、他のストーリーのテストを継続し、最後にエラーを報告できる
- **FR-013**: システムは、CI環境でベースラインをGitHub Actions Artifactsに保存し、次回実行時に取得できる

### Key Entities *(include if feature involves data)*

- **スクリーンショット**: 各Storybookストーリーの視覚的な状態を記録した画像。ストーリーIDを識別子として使用
- **ベースライン**: 承認された正しい状態のスクリーンショット。比較の基準として使用
- **差分レポート**: 視覚的な変更を記録したレポート。変更前画像、変更後画像、差分画像を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: すべての既存Storybookストーリーに対してスクリーンショットが取得できる
- **SC-002**: ローカル環境でVRTコマンドを実行し、正常に完了できる（成功率100%）
- **SC-003**: GitHub ActionsでPR作成時に自動的にVRTが実行され、結果が確認できる（自動実行成功率100%）
- **SC-004**: 視覚的な変更がない場合、差分が検出されずテストが成功する（誤検出率0%）
- **SC-005**: 視覚的な変更がある場合、差分が検出され、レポートが生成される（検出率100%）
- **SC-006**: 差分レポートが生成され、開発者が変更内容を確認できる（レポート生成成功率100%）

## Assumptions

- Storybookが既にセットアップされ、ストーリーが存在する
- GitHub Actionsが利用可能である
- 外部サービスへの依存を避ける必要がある（セキュリティ要件）
- ベースラインの管理は、初期段階ではローカル環境で行い、CI環境ではGitHub Actions Artifactsに保存して共有する
- ストーリー数が増加した場合、実行時間の最適化は将来の課題として扱う
- ベースラインの更新は、デフォルトでは手動で行い、自動更新はオプションとして提供する
- 差分検出の閾値は、デフォルト値を設定し、必要に応じて個別のストーリーで上書き可能とする

## Clarifications

### Session 2024-12-19

- Q: 意図的な視覚的変更（例：デザイン更新）後にベースラインを更新する方法 → A: 差分検出時に自動的にベースラインを更新するオプションを提供（デフォルトは手動）
- Q: VRTが失敗した場合、PRのマージをブロックするかどうか → A: VRTが失敗した場合、PRのマージをブロックする
- Q: スクリーンショット取得や比較プロセスでエラーが発生した場合の動作 → A: エラーが発生したストーリーをスキップし、他のストーリーのテストを継続し、最後にエラーを報告する
- Q: 差分検出の閾値のデフォルト設定とカスタマイズ方法 → A: デフォルト閾値を設定し、必要に応じて個別のストーリーで上書き可能
- Q: CI環境でベースラインをどのように共有・取得するか → A: ベースラインをGitHub Actions Artifactsに保存し、次回実行時に取得する

## Dependencies

- Storybookのセットアップ（既存）
- GitHub Actionsの利用可能性
- スクリーンショット取得と比較のためのツール

## Out of Scope

- 並列実行による最適化（将来対応）
- 変更検知による部分実行（将来対応）
- ベースラインの外部ストレージへの保存（将来対応）
- ストーリーの自動生成や管理機能
